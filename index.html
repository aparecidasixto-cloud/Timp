<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Station V13</title>
    <script src='https://meet.jit.si/external_api.js'></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #121212; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* --- TELA DE LOGIN --- */
        #telaLogin {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 1000; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .login-box { width: 80%; max-width: 300px; text-align: center; }
        input { width: 100%; padding: 15px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; border-radius: 5px; text-align: center; }
        .btn-entrar { width: 100%; padding: 15px; background: #0070f3; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }

        /* --- ESTÚDIO (ADMIN) --- */
        #painelAdmin { display: none; height: 100%; flex-direction: column; }
        
        /* Player Principal */
        #areaPreview { flex: 1; background: black; position: relative; display: flex; align-items: center; justify-content: center; border-bottom: 2px solid #333; }
        video { max-width: 100%; max-height: 100%; }

        /* Controles da Playlist */
        #areaControles { height: 40%; background: #1a1a1a; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; }
        
        .upload-btn { background: #333; color: white; padding: 15px; text-align: center; border: 2px dashed #555; border-radius: 5px; margin-bottom: 10px; cursor: pointer; }
        
        .playlist-item { 
            background: #222; padding: 10px; margin-bottom: 5px; border-radius: 4px; 
            display: flex; justify-content: space-between; align-items: center; font-size: 14px;
        }
        .playlist-item.active { background: #004400; border-left: 4px solid #0f0; }

        /* Botão Mágico de Transmissão */
        #btnGoLive {
            background: #d00; color: white; padding: 15px; border: none; font-weight: bold;
            font-size: 16px; margin-bottom: 10px; border-radius: 5px; cursor: pointer;
        }

        /* Jitsi Escondido (Admin) */
        #jitsi-admin-container { height: 1px; opacity: 0; overflow: hidden; }

        /* --- TV (RECEPTOR) --- */
        #telaTV { display: none; width: 100%; height: 100%; background: black; }
        #jitsi-tv-container { width: 100%; height: 100%; }

        .aviso-overlay {
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8);
            padding: 10px; border-radius: 5px; font-size: 12px; pointer-events: none; z-index: 50;
        }
    </style>
</head>
<body>

    <div id="telaLogin">
        <div class="login-box">
            <h2 style="margin-bottom:5px;">TV Station V13</h2>
            <p style="color:#aaa; font-size:12px; margin-bottom:20px;">Upload & Play</p>
            <input type="text" id="user" placeholder="Usuário (admin ou tv)">
            <input type="password" id="pass" placeholder="Senha">
            <button class="btn-entrar" onclick="fazerLogin()">ENTRAR</button>
        </div>
    </div>

    <div id="painelAdmin">
        <div id="areaPreview">
            <div class="aviso-overlay" id="statusTransmissao">MODO ESTÚDIO: OFFLINE</div>
            <video id="playerPrincipal" playsinline controls></video>
        </div>

        <div id="areaControles">
            <button id="btnGoLive" onclick="iniciarTransmissao()">
                <i class="fas fa-satellite-dish"></i> INICIAR CONEXÃO
            </button>
            
            <label class="upload-btn">
                <i class="fas fa-plus"></i> ADICIONAR VÍDEOS
                <input type="file" multiple accept="video/*" hidden onchange="carregarVideos(this)">
            </label>

            <div id="listaPlaylist">
                <div style="text-align:center; color:#555; font-size:12px; padding:10px;">
                    Adicione vídeos para começar
                </div>
            </div>
        </div>
        
        <div id="jitsi-admin-container"></div>
    </div>

    <div id="telaTV">
        <div id="jitsi-tv-container"></div>
    </div>

    <script>
        const SENHA = "093106Rm";
        const SALA_ID = "TV_STATION_PLAYLIST_093106Rm_MASTER";
        
        let playlist = [];
        let indexAtual = 0;
        let adminApi = null;

        const player = document.getElementById('playerPrincipal');
        const listaEl = document.getElementById('listaPlaylist');

        function fazerLogin() {
            const u = document.getElementById('user').value.toLowerCase();
            const p = document.getElementById('pass').value;

            if (p !== SENHA) return alert("Senha incorreta!");

            document.getElementById('telaLogin').style.display = 'none';

            if (u === "admin" || u.includes("trans")) {
                document.getElementById('painelAdmin').style.display = 'flex';
                configurarPlayer();
            } else {
                document.getElementById('telaTV').style.display = 'block';
                iniciarTV();
            }
        }

        // --- SISTEMA DE PLAYLIST (ADMIN) ---

        function carregarVideos(input) {
            const files = Array.from(input.files);
            files.forEach(f => {
                playlist.push({ nome: f.name, file: f });
            });
            renderizarPlaylist();
            
            // Se for o primeiro vídeo, carrega ele mas não dá play
            if(playlist.length > 0 && player.src === "") {
                tocarVideo(0, false); 
            }
        }

        function renderizarPlaylist() {
            listaEl.innerHTML = "";
            playlist.forEach((item, idx) => {
                listaEl.innerHTML += `
                    <div class="playlist-item ${idx === indexAtual ? 'active' : ''}" onclick="tocarVideo(${idx}, true)">
                        <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:85%">
                            ${idx + 1}. ${item.nome}
                        </div>
                        <i class="fas fa-play" style="font-size:10px;"></i>
                    </div>
                `;
            });
        }

        function tocarVideo(idx, autoPlay) {
            indexAtual = idx;
            renderizarPlaylist();
            
            const file = playlist[idx].file;
            player.src = URL.createObjectURL(file);
            
            if(autoPlay) player.play();
        }

        function configurarPlayer() {
            // Toca o próximo automaticamente
            player.onended = () => {
                if (indexAtual + 1 < playlist.length) {
                    tocarVideo(indexAtual + 1, true);
                } else {
                    // Loop ou parar? Vamos fazer loop
                    tocarVideo(0, true);
                }
            };
        }

        // --- TRANSMISSÃO (O SEGREDO DO SCREEN SHARE) ---

        function iniciarTransmissao() {
            const btn = document.getElementById('btnGoLive');
            btn.disabled = true;
            btn.style.background = "#555";
            btn.innerText = "CONECTANDO...";

            document.getElementById('statusTransmissao').innerText = "1. ABRA O MENU DO JITSI E CLIQUE EM 'COMPARTILHAR TELA'";
            
            // Mostra o container do Jitsi um pouco para o admin poder clicar nos botões se precisar
            // Mas a ideia é que ele use a interface
            
            const domain = 'meet.jit.si';
            const options = {
                roomName: SALA_ID,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#jitsi-admin-container'),
                lang: 'pt',
                configOverwrite: {
                    prejoinPageEnabled: false,
                    startWithAudioMuted: false, // Áudio ligado para comentar
                    startWithVideoMuted: true, // Câmera desligada (vamos usar tela)
                },
                interfaceConfigOverwrite: {
                    TOOLBAR_BUTTONS: ['microphone', 'desktop', 'hangup', 'settings'], // Apenas o necessário
                },
                userInfo: { displayName: "EMISSORA (ADMIN)" }
            };

            adminApi = new JitsiMeetExternalAPI(domain, options);
            
            // Truque: Quando entrar, avisa o admin
            adminApi.addEventListener('videoConferenceJoined', () => {
                alert("CONECTADO! \n\nAgora procure o botão de 'COMPARTILHAR TELA' (ícone de monitor) no menu da chamada e selecione a aba ou tela cheia.");
                document.getElementById('statusTransmissao').innerText = "NO AR (ASSIM QUE COMPARTILHAR A TELA)";
                document.getElementById('statusTransmissao').style.color = "#0f0";
            });

            // Torna o frame visível temporariamente se o admin não achar o botão
            // No mobile, o navegador pede permissão automaticamente ou mostra o botão
            document.getElementById('jitsi-admin-container').style.height = "50px"; 
            document.getElementById('jitsi-admin-container').style.opacity = "1";
        }

        // --- MODO TV (ESPECTADOR) ---

        function iniciarTV() {
            const domain = 'meet.jit.si';
            const options = {
                roomName: SALA_ID,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#jitsi-tv-container'),
                lang: 'pt',
                configOverwrite: {
                    startWithAudioMuted: true, // Começa mudo pra não bloquear
                    startWithVideoMuted: true,
                    prejoinPageEnabled: false,
                    disableDeepLinking: true, 
                },
                interfaceConfigOverwrite: {
                    TOOLBAR_BUTTONS: [], // Sem botões
                    FILM_STRIP_MAX_HEIGHT: 0,
                    SHOW_JITSI_WATERMARK: false
                },
                userInfo: { displayName: "TV ESPECTADOR" }
            };

            const tvApi = new JitsiMeetExternalAPI(domain, options);
            
            tvApi.addEventListener('videoConferenceJoined', () => {
                tvApi.executeCommand('toggleTileView'); // Garante tela cheia
            });
        }
    </script>
</body>
</html>
