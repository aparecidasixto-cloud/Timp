<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema V2.0</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .box { background: #222; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        input { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: none; }
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button.stop { background: #dc3545; }
        video { width: 100%; border-radius: 10px; margin-top: 10px; background: #111; }
        #localVideo { transform: rotateY(180deg); } /* Espelhar transmissor */
        .hidden { display: none; }
        .log { margin-top: 10px; font-size: 12px; color: #aaa; }
    </style>
</head>
<body>

    <div id="telaLogin" class="box">
        <h2>Área Restrita</h2>
        <input type="text" id="usuario" placeholder="Usuário">
        <input type="password" id="senha" placeholder="Senha">
        <button onclick="verificarLogin()">ENTRAR</button>
        <p id="msgErro" style="color:red; display:none;">Dados incorretos.</p>
    </div>

    <div id="telaTransmissor" class="box hidden">
        <h3>Transmissor (Ao Vivo)</h3>
        <p class="log">Seu ID: <span id="myIdDisplay">Gerando...</span></p>
        <video id="localVideo" autoplay muted playsinline></video>
        <div id="transmissorLog" class="log">Aguardando receptor...</div>
    </div>

    <div id="telaReceptor" class="box hidden">
        <h3>Receptor</h3>
        <video id="remoteVideo" autoplay playsinline></video>
        <button id="btnAssistir" onclick="conectarAoHost()">ASSISTIR TRANSMISSÃO</button>
        <div id="receptorLog" class="log">Clique no botão para conectar.</div>
    </div>

    <script>
        // ID FIXO DO TRANSMISSOR (Para o receptor sempre saber quem procurar)
        const HOST_ID = "sistema-seguro-093106Rm-host-v2";
        let peer = null;
        let localStream = null;

        function log(msg, elementId) {
            document.getElementById(elementId).innerText = msg;
            console.log(msg);
        }

        function verificarLogin() {
            const u = document.getElementById('usuario').value.trim();
            const s = document.getElementById('senha').value.trim();

            if (s !== "093106Rm") {
                document.getElementById('msgErro').style.display = 'block';
                return;
            }

            if (u === "trasmitir123") {
                iniciarTransmissor();
            } else if (u === "receber") {
                prepararReceptor();
            } else {
                document.getElementById('msgErro').style.display = 'block';
            }
        }

        // --- LÓGICA DO TRANSMISSOR ---
        function iniciarTransmissor() {
            document.getElementById('telaLogin').classList.add('hidden');
            document.getElementById('telaTransmissor').classList.remove('hidden');

            log("Acessando câmera...", "transmissorLog");

            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;

                // Cria o Peer com o ID fixo
                peer = new Peer(HOST_ID);

                peer.on('open', (id) => {
                    document.getElementById('myIdDisplay').innerText = id;
                    log("Online! Aguardando conexão...", "transmissorLog");
                });

                peer.on('error', (err) => {
                    if(err.type === 'unavailable-id') {
                        log("ERRO: Já existe um transmissor aberto!", "transmissorLog");
                    } else {
                        log("Erro Peer: " + err.type, "transmissorLog");
                    }
                });

                // Quando alguém ligar (Receptor), atenda enviando o stream
                peer.on('call', (call) => {
                    log("Receptor conectando...", "transmissorLog");
                    call.answer(stream); // Envia o vídeo
                    
                    // Confirmação (opcional)
                    call.on('close', () => {
                        log("Receptor desconectou.", "transmissorLog");
                    });
                });
            })
            .catch(err => {
                log("Erro Câmera: " + err.message, "transmissorLog");
                alert("Você precisa permitir a câmera!");
            });
        }

        // --- LÓGICA DO RECEPTOR ---
        function prepararReceptor() {
            document.getElementById('telaLogin').classList.add('hidden');
            document.getElementById('telaReceptor').classList.remove('hidden');
            
            // Cria um ID aleatório para o receptor
            peer = new Peer();
            
            peer.on('open', (id) => {
                log("Pronto para conectar.", "receptorLog");
            });

            peer.on('error', (err) => {
                log("Erro: " + err.type, "receptorLog");
            });
        }

        function conectarAoHost() {
            const btn = document.getElementById('btnAssistir');
            btn.disabled = true;
            btn.innerText = "CONECTANDO...";
            log("Buscando transmissor...", "receptorLog");

            // O pulo do gato: Criamos uma 'chamada' para o Host.
            // O Host vai 'atender' e nos mandar o vídeo dele.
            const call = peer.call(HOST_ID, dummyStream());

            // Quando o Host devolver o vídeo:
            call.on('stream', (remoteStream) => {
                log("Conectado! Recebendo vídeo.", "receptorLog");
                const video = document.getElementById('remoteVideo');
                video.srcObject = remoteStream;
                
                // Força o play (necessário em celulares)
                video.play().catch(e => {
                    log("Clique no vídeo para ativar o som.", "receptorLog");
                    video.controls = true; // Mostra controles se falhar o play auto
                });
                
                btn.style.display = 'none'; // Esconde o botão após conectar
            });

            // Se cair a conexão
            call.on('close', () => {
                log("Transmissão encerrada.", "receptorLog");
                btn.disabled = false;
                btn.innerText = "RECONECTAR";
                btn.style.display = 'block';
            });
            
            // Timeout simples caso o transmissor não responda
            setTimeout(() => {
                if(document.getElementById('receptorLog').innerText === "Buscando transmissor...") {
                    log("Transmissor não encontrado ou offline.", "receptorLog");
                    btn.
