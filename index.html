<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema V3.0 Final</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #000; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .box { background: #1e1e1e; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #333; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #444; background: #2a2a2a; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #0070f3; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 16px; }
        button:hover { background: #005bb5; }
        button:active { transform: scale(0.98); }
        video { width: 100%; border-radius: 10px; margin-top: 15px; background: #000; border: 1px solid #333; }
        #localVideo { transform: rotateY(180deg); }
        .hidden { display: none !important; }
        .log { margin-top: 15px; font-size: 13px; color: #888; background: #111; padding: 5px; border-radius: 4px; }
        h2, h3 { margin-top: 0; color: #fff; }
    </style>
</head>
<body>

    <div id="telaLogin" class="box">
        <h2>Acesso ao Sistema</h2>
        <input type="text" id="usuario" placeholder="Usuário (ex: receber)">
        <input type="password" id="senha" placeholder="Senha">
        <button id="btnEntrar">ENTRAR</button>
        <p id="msgStatus" style="margin-top:10px; color:#aaa; font-size:12px;">Pronto para conectar.</p>
    </div>

    <div id="telaTransmissor" class="box hidden">
        <h3>A Transmitir</h3>
        <p style="font-size:12px; color:#bbb;">Partilhe a senha "receber" para assistirem.</p>
        <video id="localVideo" autoplay muted playsinline></video>
        <div id="transmissorLog" class="log">A iniciar câmara...</div>
    </div>

    <div id="telaReceptor" class="box hidden">
        <h3>A Assistir</h3>
        <video id="remoteVideo" autoplay playsinline></video>
        <button id="btnAssistir">CLIQUE PARA VER VÍDEO</button>
        <div id="receptorLog" class="log">Aguardando...</div>
    </div>

    <script>
        // CONFIGURAÇÕES
        const HOST_ID = "sistema-seguro-093106Rm-v3-final";
        const SENHA_CORRETA = "093106Rm";
        
        // ELEMENTOS
        const btnEntrar = document.getElementById('btnEntrar');
        const inputUser = document.getElementById('usuario');
        const inputPass = document.getElementById('senha');
        const msgStatus = document.getElementById('msgStatus');

        // EVENTOS DE LOGIN (Clique e Enter)
        btnEntrar.addEventListener('click', tentarLogin);
        inputPass.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') tentarLogin();
        });

        function tentarLogin() {
            const u = inputUser.value.trim().toLowerCase(); // Converte para minúsculas
            const s = inputPass.value.trim();

            msgStatus.innerText = "A verificar dados...";

            // Verifica a Senha
            if (s !== SENHA_CORRETA) {
                alert("Senha incorreta! Tente 093106Rm");
                msgStatus.innerText = "Senha incorreta.";
                return;
            }

            // Verifica o Usuário
            // Aceita 'trasmitir123' (erro comum) ou 'transmitir123' (correto)
            if (u === "trasmitir123" || u === "transmitir123") {
                iniciarTransmissor();
            } else if (u === "receber") {
                prepararReceptor();
            } else {
                alert("Usuário não reconhecido.\nUse: 'trasmitir123' ou 'receber'");
                msgStatus.innerText = "Usuário inválido.";
            }
        }

        // --- LÓGICA DO TRANSMISSOR ---
        function iniciarTransmissor() {
            document.getElementById('telaLogin').classList.add('hidden');
            document.getElementById('telaTransmissor').classList.remove('hidden');

            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                document.getElementById('localVideo').srcObject = stream;
                
                const peer = new Peer(HOST_ID);

                peer.on('open', (id) => {
                    document.getElementById('transmissorLog').innerText = "ONLINE. O seu ID está ativo.";
                });

                peer.on('error', (err) => {
                    if(err.type === 'unavailable-id') {
                        alert("ERRO: Já existe uma janela de transmissão aberta! Feche a outra.");
                        document.getElementById('transmissorLog').innerText = "Erro: Transmissor já aberto noutro local.";
                    } else {
                        document.getElementById('transmissorLog').innerText = "Erro: " + err.type;
                    }
                });

                peer.on('call', (call) => {
                    document.getElementById('transmissorLog').innerText = "Alguém conectou-se!";
                    call.answer(stream);
                });
            })
            .catch(err => {
                alert("Erro: Permita o acesso à câmara!");
                document.getElementById('transmissorLog').innerText = "Sem câmara.";
            });
        }

        // --- LÓGICA DO RECEPTOR ---
        function prepararReceptor() {
            document.getElementById('telaLogin').classList.add('hidden');
            document.getElementById('telaReceptor').classList.remove('hidden');

            const btn = document.getElementById('btnAssistir');
            const logArea = document.getElementById('receptorLog');
            
            logArea.innerText = "Clique no botão acima para conectar.";

            btn.addEventListener('click', () => {
                btn.disabled = true;
                btn.innerText = "A CONECTAR...";
                logArea.innerText = "A procurar sinal...";

                const peer = new Peer();

                peer.on('open', () => {
                    // Liga para o transmissor
                    const call = peer.call(HOST_ID, dummyStream());

                    if(!call) {
                         logArea.innerText = "Falha ao criar chamada.";
                         restaurarBotao();
                         return;
                    }

                    call.on('stream', (remoteStream) => {
                        logArea.innerText = "Sinal recebido!";
                        const video = document.getElementById('remoteVideo');
                        video.srcObject = remoteStream;
                        video.play();
                        btn.style.display = 'none'; // Some com o botão se funcionar
                    });

                    call.on('close', () => {
                        logArea.innerText = "Transmissão caiu.";
                        restaurarBotao();
                    });
                    
                    // Timeout de segurança se não conectar em 5s
                    setTimeout(() => {
                        if(btn.style.display !== 'none') {
                            logArea.innerText = "Transmissor não encontrado (offline?).";
                            restaurarBotao();
                        }
                    }, 5000);
                });
            });

            function restaurarBotao() {
                btn.disabled = false;
                btn.innerText = "TENTAR NOVAMENTE";
            }
        }

        // Cria áudio mudo para "enganar" o navegador e permitir a conexão bidirecional
        function dummyStream() {
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const dst = ctx.createMediaStreamDestination();
            osc.connect(dst);
            return dst.stream;
        }
    </script>
</body>
</html>
